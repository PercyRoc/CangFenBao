# 🔧 设备状态通知功能说明

## 📋 功能概述

新聚力分拣系统现已集成设备状态通知功能，可以通过WebSocket实时向前端或其他客户端推送设备的上线/下线状态。

## 🚀 核心特性

- ✅ **实时设备状态通知** - 设备上线/下线时立即推送消息
- 📦 **包裹处理通知** - 包裹确定格口后立即发送到前端，支持前端动画和状态跟踪
- 🌐 **WebSocket通信** - 基于WebSocket协议的高效双向通信
- 🔧 **多设备类型支持** - 支持SKU分拣、扫码复核、大区分拣三种设备类型
- ⚙️ **可配置设备ID** - 每种分拣模式可独立配置设备ID
- 🔄 **自动状态管理** - 应用启动时自动发送上线通知，关闭时发送下线通知

## 📐 架构设计

### 服务接口层

- `IDeviceStatusNotificationService` - 设备状态通知服务接口
- `DeviceStatusNotificationService` - 具体实现类

### 配置层

- `SortingModeSettings` - 分拣模式配置，包含各种设备ID配置
- `SortingModeSettingsViewModel` - 配置界面视图模型

### 集成层

- `MainWindowViewModel` - 主界面集成设备状态通知
- `App.xaml.cs` - 应用程序级别的服务注册和生命周期管理

## 🔌 WebSocket通信协议

### 服务器地址

```
ws://localhost:8080/device-status
```

### 消息格式

#### 设备上线通知

```json
{
  "type": "deviceStatus",
  "data": {
    "deviceId": "SKU_SORT_DEVICE_1",
    "status": "ONLINE",
    "timestamp": "2024-01-01T10:00:00.000Z"
  }
}
```

#### 设备下线通知

```json
{
  "type": "deviceStatus",
  "data": {
    "deviceId": "SKU_SORT_DEVICE_1",
    "status": "OFFLINE",
    "timestamp": "2024-01-01T10:15:00.000Z"
  }
}
```

#### 包裹生成通知

```json
{
  "type": "packageReport",
  "data": {
    "packageId": "PKG_20241201_001",
    "sourceDeviceId": "CAM_SKU_01",
    "sortCode": 3,
    "timestamp": "2024-01-01T10:00:00.000Z"
  }
}
```

## 🎯 设备ID配置

### 业务区域设备ID（用于设备状态）

| 分拣模式    | 默认设备ID                 | 描述       |
|---------|------------------------|----------|
| SKU分拣模式 | `SKU_SORT_DEVICE_1`    | SKU分拣设备1 |
| 扫码复核模式  | `SCAN_CHECK_DEVICE_1`  | 扫码复核设备1  |
| 大区分拣模式  | `REGION_SORT_DEVICE_1` | 大区分拣设备1  |

### 源设备ID（用于包裹报告）

| 分拣模式    | 源设备ID         | 描述       |
|---------|---------------|----------|
| SKU分拣模式 | `CAM_SKU_01`  | SKU分拣相机1 |
| 扫码复核模式  | `CAM_SCAN_01` | 扫码复核相机1  |
| 大区分拣模式  | `CAM_REG_01`  | 大区分拣相机1  |

### 配置方法

1. 打开主程序，进入"设置"页面
2. 选择"分拣方式设置"
3. 在"设备ID配置"区域修改对应设备的ID
4. 点击"保存"按钮应用配置

## 💻 使用示例

### 启动WebSocket服务器

```csharp
var deviceService = Container.Resolve<IDeviceStatusNotificationService>();
await deviceService.StartAsync(8080);
```

### 发送设备上线通知

```csharp
await deviceService.NotifyDeviceOnlineAsync("SKU_SORT_DEVICE_1");
```

### 发送设备下线通知

```csharp
await deviceService.NotifyDeviceOfflineAsync("SKU_SORT_DEVICE_1");
```

### 发送包裹生成通知

```csharp
await deviceService.NotifyPackageCreatedAsync("PKG_20241201_001", "CAM_SKU_01", 3);
```

### 停止WebSocket服务器

```csharp
await deviceService.StopAsync();
```

## 🧪 测试方法

### 使用提供的测试页面

1. 确保新聚力应用程序正在运行
2. 用浏览器打开 `websocket-test.html` 文件
3. 点击"连接"按钮连接WebSocket服务器
4. 观察设备状态变化、包裹处理统计和消息日志
5. 测试包裹处理：在新聚力程序中处理包裹，观察前端实时显示包裹报告

### 使用浏览器开发者工具

```javascript
// 连接WebSocket
const ws = new WebSocket('ws://localhost:8080/device-status');

// 监听消息
ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    
    if (data.type === 'deviceStatus') {
        console.log('收到设备状态:', data);
    } else if (data.type === 'packageReport') {
        console.log('收到包裹报告:', data);
        // 处理包裹报告逻辑，如动画控制等
    }
};

// 连接成功
ws.onopen = function() {
    console.log('WebSocket连接成功');
};
```

## 🔧 技术实现细节

### 自动生命周期管理

- **应用启动时**: 自动启动WebSocket服务器并发送当前设备上线通知
- **应用关闭时**: 发送设备下线通知并停止WebSocket服务器
- **分拣模式切换时**: 根据新模式获取对应设备ID并更新通知

### 异常处理

- WebSocket连接异常自动记录日志
- 消息发送失败不影响主程序运行
- 服务启动/停止超时控制，避免阻塞应用

### 性能优化

- 使用线程安全的并发字典管理客户端连接
- 异步消息发送，避免阻塞UI线程
- 连接状态实时监控和管理

## 📊 监控指标

### 服务状态

- `IsRunning` - WebSocket服务器运行状态
- `ConnectedClientsCount` - 当前连接的客户端数量

### 事件通知

- `ServerStarted` - 服务器启动事件
- `ServerStopped` - 服务器停止事件
- `ClientConnected` - 客户端连接事件
- `ClientDisconnected` - 客户端断开事件

## 🛠️ 故障排除

### 常见问题

**Q: WebSocket无法连接？**
A: 检查防火墙设置，确保8080端口未被阻止

**Q: 设备状态没有更新？**
A: 确认设备ID配置正确，检查应用日志

**Q: 多个客户端连接有问题？**
A: 检查网络连接，每个客户端都应该能独立连接

### 日志位置

应用程序日志保存在 `logs/app-{date}.log` 文件中，包含详细的设备状态通知记录。

## 📝 开发说明

### 扩展新设备类型

1. 在 `SortingModeSettings` 中添加新的设备ID属性
2. 更新 `GetCurrentDeviceId()` 方法包含新设备类型
3. 在配置界面中添加对应的输入框
4. 更新测试页面显示新设备

### 自定义消息格式

可以在 `DeviceStatusNotificationService` 中修改 `SendDeviceStatusAsync` 方法来自定义消息格式。

---

💡 **提示**: 此功能完全向下兼容，不启用WebSocket客户端时不会影响现有分拣功能。 
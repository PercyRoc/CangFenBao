# TCP相机模拟器 - 压力测试工具 v2.1

专门用于测试TCP相机服务性能和稳定性的压力测试工具，特别针对背压问题的修复验证。支持多种测试模式，包括全新的**PLC+相机协调模式**，可以真实模拟生产环境中的设备交互场景。

## 🆕 v2.1 新功能

### PLC+相机协调模式
- **真实场景模拟**：完全复现生产环境中PLC信号触发相机的工作流程
- **精确时序控制**：PLC发送包裹序号 → 延迟800-900ms → 相机发送数据包
- **独立设备模拟**：PLC客户端和相机客户端并行运行，模拟两个独立设备
- **协调统计监控**：提供信号匹配率、延迟分布等专门的统计指标

### 增强功能
- **Serilog日志集成**：详细的结构化日志记录
- **延迟统计分析**：相机处理延迟的统计和监控
- **多模式统一界面**：标准、压测、协调三种模式的统一管理
- **优化的错误处理**：更健壮的连接和异常处理机制

## 📋 功能特性

### 核心测试模式
1. **标准模式**：独立相机客户端并发测试
2. **压测模式**：高强度突发负载测试  
3. **🔧📸 协调模式**：PLC+相机协调测试（**推荐用于背压验证**）

### 测试能力
- **多客户端并发**：支持1-20个并发TCP客户端
- **实时性能监控**：延迟分析(P50/P90/P95/P99)、吞吐量统计、连接状态监控
- **灵活参数配置**：支持自定义频率、延迟、端口等所有关键参数
- **交互式控制**：运行时按键查看统计、重置数据、延迟分析

### 专门针对背压问题
- **136秒延迟复现**：协调模式能准确复现您遇到的长时间阻塞问题
- **Subject背压验证**：验证三层隔离架构的修复效果
- **专用线程监控**：监控TCP专用数据处理线程的性能表现

## 🚀 快速开始

### 方式一：使用快速测试脚本（推荐）
```bash
# Windows
test-scripts.bat

# 选择测试场景
请选择测试场景:
1. 标准性能测试 (3客户端, 15包/秒, 5分钟)
2. 高并发压力测试 (10客户端, 50包/秒, 3分钟)  
3. 背压修复验证 (5客户端, 突发100包, 2分钟)
4. PLC+相机协调测试 (推荐 - 真实场景模拟)
5. 高频协调测试 (20包/秒, 800-900ms延迟)
6. 长期稳定性测试 (2客户端, 5包/秒, 60分钟)
7. 自定义参数测试
8. 显示帮助信息
```

### 方式二：直接运行命令
```bash
# 编译项目
dotnet build

# PLC+相机协调测试（推荐）
dotnet run -- --coordinated --rate 10 --duration 180

# 标准并发测试
dotnet run -- --clients 5 --rate 20 --duration 120

# 高强度压测
dotnet run -- --stress --clients 10 --burst 50 --duration 120
```

## 🔧 协调模式详解

### 工作原理
```
PLC模拟器 ---[序号信号]---> 相机模拟器
    |                           |
    |                      [延迟800-900ms]
    |                           |
    v                           v
PLC服务器                   相机服务器
(端口20010)                 (端口20011)
```

### 核心特性
- **真实设备模拟**：两个独立的TCP客户端分别连接PLC和相机服务器
- **时序精确控制**：PLC发送信号后，相机延迟800-900ms发送对应数据
- **数据关联性**：相机数据包中的条码与PLC序号完全对应，确保可追踪
- **统计监控**：提供信号匹配率、延迟分布、发送成功率等专门指标

### 使用场景
1. **背压问题验证**：最接近生产环境，能准确复现136秒阻塞问题
2. **修复效果验证**：验证三层隔离架构是否彻底解决Subject背压
3. **性能基准测试**：建立真实场景下的性能基准
4. **长期稳定性测试**：验证修复后的长期稳定性

## 📊 命令行参数

### 基础参数
```bash
-h, --host <地址>           相机服务器地址 (默认: 127.0.0.1)
-p, --port <端口>           相机服务器端口 (默认: 20011)
    --plc-host <地址>       PLC服务器地址 (默认: 127.0.0.1)
    --plc-port <端口>       PLC服务器端口 (默认: 20010)
-c, --clients <数量>        并发客户端数量 (默认: 3)
-r, --rate <频率>           每秒发送包裹数 (默认: 10)
-d, --duration <秒>         测试持续时间 (默认: 60)
```

### 模式控制
```bash
-s, --stress                启用高强度压测模式
-b, --burst <数量>          突发模式每批发送数量 (默认: 20)
    --coordinated           启用PLC+相机协调模式
    --camera-delay-min <ms> 相机延迟最小值 (默认: 800)
    --camera-delay-max <ms> 相机延迟最大值 (默认: 900)
```

## 📈 测试示例

### 1. 背压修复验证（推荐）
```bash
# 协调模式 - 最接近生产环境
dotnet run -- --coordinated --rate 15 --camera-delay-min 800 --camera-delay-max 900 --duration 300

# 预期结果：
# - 信号匹配率 > 99%
# - 相机延迟稳定在800-900ms范围
# - 无"相机数据流处理延迟异常"警告
# - 无136秒等极端延迟
```

### 2. 高并发性能测试
```bash
# 标准高并发
dotnet run -- --clients 10 --rate 50 --duration 180

# 协调高并发
dotnet run -- --coordinated --rate 25 --duration 180

# 预期结果：
# - P99延迟 < 200ms
# - 吞吐量达成率 > 90%
# - 成功率 > 99%
```

### 3. 突发负载压测
```bash
# 传统压测模式
dotnet run -- --stress --clients 5 --burst 100 --duration 120

# 预期结果：
# - 无长时间阻塞（>5秒）
# - 突发处理能力稳定
# - 连接恢复快速
```

### 4. 长期稳定性验证
```bash
# 低频长期测试
dotnet run -- --coordinated --rate 5 --duration 3600

# 预期结果：
# - 60分钟内无累积延迟
# - 内存使用稳定
# - 连接状态健康
```

## 🎯 验证清单

### 背压修复验证
- [ ] 延迟P99 < 200ms
- [ ] 吞吐量达成率 > 90%
- [ ] 成功率 > 99%
- [ ] 协调模式信号匹配率 > 99%
- [ ] 无"相机数据流处理延迟异常"警告
- [ ] 无"Subject.OnNext耗时异常"警告
- [ ] 无136秒等极端延迟

### 性能基准
- [ ] 标准模式：3客户端15包/秒稳定运行
- [ ] 高并发模式：10客户端50包/秒达成80%+
- [ ] 协调模式：20包/秒信号处理无延迟累积
- [ ] 长期稳定：60分钟测试无性能衰减

## 🔧 运行时控制

测试运行期间可使用以下按键：
- `q` - 退出测试
- `s` - 显示详细统计
- `r` - 重置统计数据  
- `l` - 显示延迟分析
- `d` - 显示延迟统计（协调模式）

## 📋 输出示例

### 协调模式统计
```
📊 [协调统计] PLC发送: 150(150成功) | 相机接收: 150 | 相机发送: 148 | 总速率: 10.2 包/秒
📈 [延迟分析] 样本: 148 | 平均: 45.2ms | P50: 32.1ms | P90: 78.3ms | P95: 95.1ms | P99: 156.7ms

=== 相机延迟统计 ===
样本数量: 148
平均延迟: 852.3ms
最小延迟: 801.2ms
最大延迟: 898.7ms
```

### 最终报告
```
🎯 ================ 最终测试报告 ================
测试配置:
  模式: PLC+相机协调模式
  PLC服务器: 127.0.0.1:20010
  相机服务器: 127.0.0.1:20011
  相机延迟: 800-900ms
  目标频率: 10 包/秒
  测试时长: 180 秒

性能结果:
  总发送包裹: 1,798
  发送成功: 1,796
  发送失败: 2
  成功率: 99.89%
  实际吞吐量: 9.98 包/秒

协调模式结果:
  PLC信号发送: 1,800
  相机触发次数: 1,798
  信号匹配率: 99.89%
  平均相机延迟: 850.2ms
  延迟范围: 801.1ms - 899.8ms
```

## 🛠️ 开发和调试

### 项目结构
```
TcpCameraSimulator/
├── Program.cs                    # 主程序入口
├── PlcSimulator.cs              # PLC模拟器
├── CoordinatedCameraSimulator.cs # 协调相机模拟器
├── AdvancedStressTest.cs        # 高级压测逻辑
├── test-scripts.bat             # Windows快速测试脚本
└── README.md                    # 本文档
```

### 扩展开发
- **新增协议支持**：在对应的模拟器类中修改数据格式
- **自定义统计指标**：扩展统计收集和报告逻辑
- **集成测试框架**：可轻松集成到CI/CD管道

## 📞 技术支持

### 常见问题
1. **连接失败**：检查目标服务器是否启动，端口是否正确
2. **延迟异常**：查看是否有防火墙或网络设备干扰
3. **协调模式无响应**：确认PLC和相机服务器都已启动并监听对应端口

### 调试建议
- 使用`-d 30`缩短测试时间进行快速验证
- 启用详细日志查看连接和发送详情
- 协调模式下重点关注信号匹配率和延迟分布

---

**特别说明**：本工具专门针对TCP相机服务的背压问题设计，协调模式能最真实地复现生产环境中的设备交互场景，强烈推荐用于验证Subject背压修复的效果。 
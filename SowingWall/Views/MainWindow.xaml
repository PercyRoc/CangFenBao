<hc:Window x:Class="SowingWall.Views.MainWindow"
           xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
           xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
           xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
           xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
           xmlns:hc="https://handyorg.github.io/handycontrol"
           xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
           xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
           xmlns:viewModels="clr-namespace:SowingWall.ViewModels"
           xmlns:mvvm="http://prismlibrary.com/"
           xmlns:localConverters="clr-namespace:SowingWall.Converters"
           xmlns:sharedConverters="clr-namespace:SharedUI.Converters;assembly=SharedUI"
           mc:Ignorable="d"
           d:DataContext="{d:DesignInstance Type=viewModels:MainViewModel}"
           mvvm:ViewModelLocator.AutoWireViewModel="True"
           Title="智能播种墙系统" Height="768" Width="1024"
           WindowStartupLocation="CenterScreen"
           ShowNonClientArea="False" ShowTitle="False"
           MinWidth="800" MinHeight="600">

    <Window.Resources>
        <ResourceDictionary>
            <localConverters:CellStatusToBrushConverter x:Key="CellStatusToBrushConverter" />
            <localConverters:CellStatusToIconConverter x:Key="CellStatusToIconConverter" />
            <localConverters:CellStatusToIconForegroundConverter x:Key="CellStatusToIconForegroundConverter" />
            <sharedConverters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" TrueValue="Visible" FalseValue="Collapsed" />
        </ResourceDictionary>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" /> 
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Custom Title Bar -->
        <Grid Grid.Row="0" Height="35" Background="{DynamicResource RegionBrush}" hc:WindowAttach.IsDragElement="True">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Left Logo & Commands Area -->
            <StackPanel Grid.Column="0" Orientation="Horizontal">
                <Image Source="/logo.ico" Width="28" Height="28" VerticalAlignment="Center" Margin="5,0,10,0" />
                <ui:Button Command="{Binding OpenHistoryCommand}" Appearance="Primary" ToolTip="查看历史记录"
                           VerticalAlignment="Center" Margin="0,0,5,0">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="History24" Margin="0,0,5,0" />
                        <TextBlock Text="历史纪录" VerticalAlignment="Center" />
                    </StackPanel>
                </ui:Button>
                <ui:Button Command="{Binding OpenSettingsCommand}" Appearance="Primary" ToolTip="打开系统设置"
                           VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="Settings24" Margin="0,0,5,0" />
                        <TextBlock Text="系统设置" VerticalAlignment="Center" />
                    </StackPanel>
                </ui:Button>
            </StackPanel>

            <!-- Center Title Area -->
            <TextBlock Grid.Column="1" Text="智能播种墙系统" HorizontalAlignment="Center" VerticalAlignment="Center"
                        FontSize="24" FontWeight="Bold" Margin="5,0" />

            <!-- Right Window Commands Area -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <ui:Button Command="{Binding MinimizeWindowCommand}" Appearance="Secondary" ToolTip="最小化">
                    <ui:SymbolIcon Symbol="Subtract24" />
                </ui:Button>
                <ui:Button Command="{Binding MaximizeRestoreWindowCommand}" Appearance="Secondary" ToolTip="最大化/还原">
                    <ui:SymbolIcon Symbol="SquareMultiple24" />
                </ui:Button>
                <ui:Button Command="{Binding CloseWindowCommand}" Appearance="Secondary" ToolTip="关闭">
                    <ui:SymbolIcon Symbol="Dismiss24" />
                </ui:Button>
            </StackPanel>
        </Grid>

        <!-- Main Content Grid Wrapper (Margins applied here) -->
        <Grid Grid.Row="1" Grid.RowSpan="2" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" /> <!-- Top Info Area Row -->
                <RowDefinition Height="*" />    <!-- Main Content Row -->
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- 顶部信息区 (美化后) -->
            <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2" 
                    Padding="15" Margin="0,0,0,10" 
                    BorderThickness="1" BorderBrush="{DynamicResource BorderBrush}" 
                    CornerRadius="5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Task Info -->
                        <RowDefinition Height="Auto"/> <!-- Barcode Scan -->
                        <RowDefinition Height="Auto"/> <!-- Instruction -->
                    </Grid.RowDefinitions>

                    <!-- Task Info -->
                    <TextBlock Grid.Row="0" Text="{Binding CurrentTaskInfo}" 
                               FontSize="18" FontWeight="SemiBold" 
                               Margin="0,0,0,15" /> 

                    <!-- Barcode Scan -->
                    <Grid Grid.Row="1" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="扫描波次号:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,10,5" FontSize="16" />
                                   
                        <hc:TextBox Grid.Row="0" Grid.Column="1" x:Name="WaveIdTextBox" 
                                    Text="{Binding WaveIdText, UpdateSourceTrigger=PropertyChanged}" 
                                    hc:InfoElement.Placeholder="请扫描或输入波次号"
                                    FontSize="16" VerticalContentAlignment="Center" Margin="0,0,0,5" />
                        
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="扫描SKU:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,5,10,0" FontSize="16" />
                                   
                        <hc:TextBox Grid.Row="1" Grid.Column="1" x:Name="BarcodeTextBox" 
                                    Text="{Binding BarcodeText, UpdateSourceTrigger=PropertyChanged}" 
                                    hc:InfoElement.Placeholder="请扫描商品SKU"
                                    FontSize="16" VerticalContentAlignment="Center" Margin="0,5,0,0" />
                                    
                        <ui:Button Grid.Row="1" Grid.Column="2" 
                                   Icon="{ui:SymbolIcon Dismiss20}" 
                                   Command="{Binding ClearBarcodeCommand}" 
                                   ToolTip="清空SKU"
                                   Appearance="Secondary" 
                                   Margin="10,5,0,0" VerticalAlignment="Center"/>
                    </Grid>

                    <!-- Instruction Text -->
                    <TextBlock Grid.Row="2" x:Name="InstructionTextBlock" 
                               Text="{Binding InstructionText}" 
                               FontSize="16" FontWeight="Medium" 
                               Foreground="DodgerBlue"
                               Margin="0,5,0,0" TextWrapping="Wrap" />
                </Grid>
            </Border>

            <Border Grid.Row="1" Grid.Column="0" Padding="5" BorderThickness="1"
                    BorderBrush="{DynamicResource BorderBrush}">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <ItemsControl x:Name="SowingCellsControl" ItemsSource="{Binding SowingCells}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="10" Rows="8" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <hc:Card Margin="5" Padding="0" Width="120" Height="100"
                                         hc:BorderElement.CornerRadius="5">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <Border
                                            Background="{Binding Status, Converter={StaticResource CellStatusToBrushConverter}}"
                                            CornerRadius="5,5,0,0" Padding="5">
                                            <TextBlock Text="{Binding CellNumber}" FontSize="16" FontWeight="Bold"
                                                       HorizontalAlignment="Center" Foreground="White" />
                                        </Border>

                                        <iconPacks:PackIconMaterial
                                            Kind="{Binding Status, Converter={StaticResource CellStatusToIconConverter}}"
                                            Grid.Row="1" Width="30" Height="30"
                                            HorizontalAlignment="Center" VerticalAlignment="Center"
                                            Foreground="{Binding Status, Converter={StaticResource CellStatusToIconForegroundConverter}}" />

                                        <TextBlock Grid.Row="2" Text="{Binding QuantityDisplay}" FontSize="14"
                                                   HorizontalAlignment="Center" Margin="0,5,0,5" />

                                        <!-- 简单的状态高亮，可以根据需要做得更复杂 -->
                                        <Border Grid.Row="0" BorderBrush="OrangeRed" BorderThickness="3" CornerRadius="5"
                                                Visibility="{Binding IsCurrentTarget, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                    </Grid>
                                </hc:Card>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>

            <!-- 右侧包裹信息区 (Now Grid.Row=1, Grid.Column=1 within this inner Grid) -->
            <Border Grid.Row="1" Grid.Column="1" Padding="10" Margin="10,0,0,0" BorderThickness="1"
                    BorderBrush="{DynamicResource BorderBrush}" MinWidth="300">
                <StackPanel Orientation="Vertical">
                    <TextBlock Text="当前包裹信息" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"
                               HorizontalAlignment="Center" />

                    <!-- 包裹详细信息 -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                             <RowDefinition Height="Auto"/> 
                             <RowDefinition Height="Auto"/> 
                             <RowDefinition Height="Auto"/> 
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="条码:" FontWeight="SemiBold" Margin="0,3,5,3"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding CurrentPackage.Barcode}" Margin="0,3" TextWrapping="Wrap"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="格口:" FontWeight="SemiBold" Margin="0,3,5,3"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding CurrentPackage.ChuteNumber}" Margin="0,3"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="状态:" FontWeight="SemiBold" Margin="0,3,5,3"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding CurrentPackage.StatusDisplay}" Margin="0,3"/>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Growl消息容器 (Still relative to the outer Grid) -->
            <StackPanel hc:Growl.GrowlParent="True"
                        Grid.Row="0" Grid.RowSpan="2"
                        Grid.Column="0" Grid.ColumnSpan="2"
                        VerticalAlignment="Top"
                        HorizontalAlignment="Right"
                        Margin="0,10,10,0"
                        Panel.ZIndex="1000" />
        </Grid>
    </Grid>
</hc:Window>
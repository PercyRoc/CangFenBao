<ui:FluentWindow
    x:Class="LosAngelesExpress.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:viewModels="clr-namespace:LosAngelesExpress.ViewModels"
    Title="CangFenBao - Rookie"
    d:DataContext="{d:DesignInstance Type=viewModels:MainViewModel}"
    Closing="MetroWindow_Closing"
    ExtendsContentIntoTitleBar="False"
    Loaded="MainWindow_Loaded"
    WindowStartupLocation="Manual"
    mc:Ignorable="d">
    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </ui:FluentWindow.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="32" />
            <RowDefinition Height="*" />
            <RowDefinition Height="28" />
        </Grid.RowDefinitions>
        <!--  标题栏  -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!--  应用图标  -->
            <Border
                Grid.Column="0"
                Width="48"
                Height="32">
                <Image
                    Width="32"
                    Height="32"
                    Margin="8,0,8,0"
                    VerticalAlignment="Center"
                    RenderOptions.BitmapScalingMode="HighQuality"
                    Source="/logo.ico">
                    <Image.Effect>
                        <DropShadowEffect
                            BlurRadius="8"
                            Direction="315"
                            Opacity="0.6"
                            ShadowDepth="2"
                            Color="#40000000" />
                    </Image.Effect>
                </Image>
            </Border>

            <!--  系统设置按钮  -->
            <ui:Button
                Grid.Column="1"
                Margin="0,0,8,0"
                Padding="8,6"
                Appearance="Primary"
                Command="{Binding OpenSettingsCommand}"
                ToolTip="System Settings">
                <StackPanel Orientation="Horizontal">
                    <ui:SymbolIcon Margin="0,0,8,0" Symbol="Settings24" />
                    <TextBlock VerticalAlignment="Center" Text="Settings" />
                </StackPanel>
            </ui:Button>

            <!--  历史记录按钮  -->
            <ui:Button
                Grid.Column="2"
                Margin="0,0,8,0"
                Padding="8,6"
                Appearance="Primary"
                Command="{Binding OpenHistoryCommand}"
                ToolTip="History">
                <StackPanel Orientation="Horizontal">
                    <ui:SymbolIcon Margin="0,0,8,0" Symbol="History24" />
                    <TextBlock VerticalAlignment="Center" Text="History" />
                </StackPanel>
            </ui:Button>

            <!--  标题  -->
            <TextBlock
                Grid.Column="3"
                Margin="0,0,8,0"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                FontFamily="微软雅黑"
                FontSize="20"
                FontWeight="SemiBold"
                Foreground="black"
                Text="CangFenBao - Express"
                TextOptions.TextFormattingMode="Display"
                TextOptions.TextRenderingMode="ClearType">
                <TextBlock.Effect>
                    <DropShadowEffect
                        BlurRadius="4"
                        Direction="270"
                        Opacity="0.2"
                        ShadowDepth="1" />
                </TextBlock.Effect>
            </TextBlock>

            <!--  TitleBar  -->
            <ui:TitleBar
                Title=""
                Grid.Column="4"
                ButtonsForeground="#FF008891"
                ShowClose="True"
                ShowMaximize="True"
                ShowMinimize="True" />

            <Border
                Grid.Column="0"
                Grid.ColumnSpan="5"
                Height="1"
                VerticalAlignment="Bottom"
                Background="#20008080"
                BorderBrush="#40FFFFFF"
                BorderThickness="0,0,0,1" />
        </Grid>
        <!--  主要内容区域  -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="3*" />
            </Grid.ColumnDefinitions>

            <!--  左侧面板  -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  实时包裹信息  -->
                <Border Grid.Row="0" Margin="16">
                    <Grid Margin="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!--  标题  -->
                        <DockPanel Grid.Row="0" Margin="0,0,0,16">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Width="24"
                                    Height="24"
                                    VerticalAlignment="Center"
                                    Foreground="{DynamicResource AccentBrush}"
                                    Symbol="Backpack24" />
                                <TextBlock
                                    Margin="8,0,0,0"
                                    VerticalAlignment="Center"
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource AccentBrush}"
                                    Text="Real-time Package Info" />
                            </StackPanel>
                        </DockPanel>

                        <!--  条码信息  -->
                        <StackPanel Grid.Row="1" Margin="0,0,0,16">
                            <TextBlock
                                Margin="0,0,0,8"
                                FontSize="14"
                                FontWeight="SemiBold"
                                Foreground="{DynamicResource AccentBrush}"
                                Text="Barcode" />

                            <ui:TextBox
                                FontSize="20"
                                FontWeight="Bold"
                                Foreground="{StaticResource AccentBrush}"
                                Icon="BarcodeScanner24"
                                PlaceholderText="Waiting for scan..."
                                Tag="barcode"
                                Text="{Binding CurrentBarcode, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>

                        <!--  信息卡片网格  -->
                        <ItemsControl Grid.Row="2" ItemsSource="{Binding PackageInfoItems}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="2" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Height="90"
                                        Margin="4"
                                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>

                                            <!--  标题和图标  -->
                                            <DockPanel Grid.Row="0" Margin="12,8,12,0">
                                                <TextBlock
                                                    FontSize="12"
                                                    FontWeight="SemiBold"
                                                    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                    Text="{Binding Label}" />
                                                <Border
                                                    Width="24"
                                                    Height="24"
                                                    HorizontalAlignment="Right"
                                                    CornerRadius="4">
                                                    <ui:SymbolIcon
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Symbol="{Binding Icon}" />
                                                </Border>
                                            </DockPanel>

                                            <!--  值和单位  -->
                                            <StackPanel
                                                Grid.Row="1"
                                                Margin="12,4,12,8"
                                                VerticalAlignment="Center">
                                                <DockPanel>
                                                    <TextBlock
                                                        FontSize="24"
                                                        FontWeight="SemiBold"
                                                        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                        Text="{Binding Value}" />
                                                    <TextBlock
                                                        Margin="4,0,0,0"
                                                        VerticalAlignment="Bottom"
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Text="{Binding Unit}" />
                                                </DockPanel>
                                                <TextBlock
                                                    Margin="0,4,0,0"
                                                    FontSize="11"
                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                    Text="{Binding Description}" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>

                <!--  统计信息区域  -->
                <Border Grid.Row="1" Margin="16">
                    <Grid Margin="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!--  标题  -->
                        <DockPanel Grid.Row="0">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Width="24"
                                    Height="24"
                                    VerticalAlignment="Center"
                                    Foreground="{DynamicResource AccentBrush}"
                                    Symbol="ChartMultiple24" />
                                <TextBlock
                                    Margin="8,0,0,0"
                                    VerticalAlignment="Center"
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource AccentBrush}"
                                    Text="Statistics" />
                            </StackPanel>
                        </DockPanel>

                        <!--  统计卡片网格  -->
                        <ItemsControl Grid.Row="1" ItemsSource="{Binding StatisticsItems}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="2" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Height="100"
                                        Margin="4"
                                        Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!--  标题和图标  -->
                                            <DockPanel Grid.Row="0" Margin="12,8,12,0">
                                                <TextBlock
                                                    FontSize="12"
                                                    FontWeight="SemiBold"
                                                    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                    Text="{Binding Label}" />
                                                <Border
                                                    Width="24"
                                                    Height="24"
                                                    HorizontalAlignment="Right"
                                                    CornerRadius="4">
                                                    <ui:SymbolIcon
                                                        Width="14"
                                                        Height="14"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Foreground="White"
                                                        Symbol="{Binding Icon}" />
                                                </Border>
                                            </DockPanel>

                                            <!--  值和单位  -->
                                            <StackPanel
                                                Grid.Row="1"
                                                Margin="12,4,12,4"
                                                VerticalAlignment="Center">
                                                <DockPanel>
                                                    <TextBlock
                                                        FontSize="28"
                                                        FontWeight="SemiBold"
                                                        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                        Text="{Binding Value}" />
                                                    <TextBlock
                                                        Margin="4,0,0,0"
                                                        VerticalAlignment="Bottom"
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Text="{Binding Unit}" />
                                                </DockPanel>
                                            </StackPanel>

                                            <!--  描述  -->
                                            <TextBlock
                                                Grid.Row="2"
                                                Margin="12,0,12,8"
                                                FontSize="11"
                                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                Text="{Binding Description}"
                                                TextWrapping="Wrap" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Border>
            </Grid>

            <!--  右侧面板  -->
            <Grid
                Grid.Row="0"
                Grid.Column="1"
                Margin="16,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="2*" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  图片显示区域 - 修改为左右两个  -->
                <Grid Grid.Row="0" Margin="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!--  左侧：体积相机实时图像  -->
                    <Border Margin="0,0,0,0">
                        <Grid Margin="16">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <StackPanel
                                Grid.Row="0"
                                Margin="0,0,0,8"
                                Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Margin="0,0,8,0"
                                    VerticalAlignment="Center"
                                    Foreground="{StaticResource AccentBrush}"
                                    Symbol="Record24" />
                                <TextBlock
                                    VerticalAlignment="Center"
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Foreground="{StaticResource AccentBrush}"
                                    Text="Real-time Camera Image" />
                            </StackPanel>

                            <Image
                                Grid.Row="1"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                RenderOptions.BitmapScalingMode="HighQuality"
                                RenderOptions.EdgeMode="Aliased"
                                Source="{Binding CurrentImage}"
                                Stretch="Fill"
                                StretchDirection="Both" />
                        </Grid>
                    </Border>


                </Grid>

                <!--  历史包裹信息  -->
                <Border Grid.Row="1" Margin="16">
                    <Grid Margin="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!--  标题栏  -->
                        <StackPanel
                            Grid.Row="0"
                            Margin="0,0,0,8"
                            Orientation="Horizontal">
                            <ui:SymbolIcon
                                Margin="0,0,8,0"
                                VerticalAlignment="Center"
                                Foreground="{StaticResource AccentBrush}"
                                Symbol="History24" />
                            <TextBlock
                                VerticalAlignment="Center"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Foreground="{StaticResource AccentBrush}"
                                Text="Package History" />
                        </StackPanel>

                        <!--  数据表格  -->
                        <DataGrid
                            Grid.Row="1"
                            AutoGenerateColumns="False"
                            CanUserAddRows="False"
                            CanUserDeleteRows="False"
                            CellStyle="{DynamicResource DefaultDataGridCellStyle}"
                            ColumnHeaderStyle="{DynamicResource DefaultDataGridColumnHeaderStyle}"
                            GridLinesVisibility="Horizontal"
                            ItemsSource="{Binding PackageHistory}"
                            RowStyle="{DynamicResource DefaultDataGridRowStyle}"
                            Style="{DynamicResource DefaultDataGridStyle}">
                            <DataGrid.Columns>
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="100"
                                    Binding="{Binding Index}"
                                    Header="Index" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="120"
                                    Binding="{Binding Barcode}"
                                    Header="Barcode" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="60"
                                    Binding="{Binding WeightDisplay}"
                                    Header="Scale" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="100"
                                    Binding="{Binding VolumeDisplay}"
                                    Header="Dimensions" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="100"
                                    Binding="{Binding ChuteNumber}"
                                    Header="Chute" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="70"
                                    Binding="{Binding StatusDisplay}"
                                    Header="Status" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="100"
                                    Binding="{Binding ProcessingTime, StringFormat={}{0:0}ms}"
                                    Header="Proc. Time" />
                                <DataGridTextColumn
                                    Width="SizeToCells"
                                    MinWidth="100"
                                    Binding="{Binding CreateTime, StringFormat={}{0:HH:mm:ss}}"
                                    Header="Time" />
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
        <!--  状态栏  -->
        <Border
            Grid.Row="2"
            BorderBrush="{StaticResource BorderBrush}"
            BorderThickness="0,1,0,0"
            Opacity="0.8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!--  CPU状态  -->
                <StackPanel
                    Grid.Column="0"
                    Margin="8,0"
                    Orientation="Horizontal">
                    <ui:SymbolIcon
                        Margin="0,0,4,0"
                        FontSize="14"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Symbol="DeviceEq24" />
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding SystemStatus.CpuUsage, StringFormat=CPU: {0:F1}%}" />
                </StackPanel>

                <!--  内存状态  -->
                <StackPanel
                    Grid.Column="1"
                    Margin="8,0"
                    Orientation="Horizontal">
                    <ui:SymbolIcon
                        Margin="0,0,4,0"
                        FontSize="14"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Symbol="Memory16" />
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding SystemStatus.MemoryUsage, StringFormat=Memory: {0:F1}%}" />
                </StackPanel>

                <!--  硬盘状态  -->
                <ItemsControl Grid.Column="2" ItemsSource="{Binding SystemStatus.Disks}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel
                                Margin="8,0"
                                Orientation="Horizontal"
                                Visibility="{Binding IsReady, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <ui:SymbolIcon
                                    Margin="0,0,4,0"
                                    FontSize="14"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Symbol="HardDrive24" />
                                <TextBlock
                                    VerticalAlignment="Center"
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                                    <Run Text="{Binding Name, Mode=OneWay}" />
                                    <Run Text=": " />
                                    <Run Text="{Binding UsagePercentage, StringFormat={}{0:F1}%, Mode=OneWay}" />
                                </TextBlock>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!--  设备状态  -->
                <ItemsControl
                    Grid.Column="4"
                    Margin="8,0"
                    ItemsSource="{Binding DeviceStatuses}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="8,0" Orientation="Horizontal">
                                <ui:SymbolIcon
                                    Margin="0,0,4,0"
                                    FontSize="14"
                                    Foreground="{Binding StatusColor}"
                                    Symbol="{Binding Icon}" />
                                <TextBlock VerticalAlignment="Center" FontSize="12">
                                    <Run Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                         Text="{Binding Name}" />
                                    <Run Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text=": " />
                                    <Run Foreground="{Binding StatusColor}" Text="{Binding Status}" />
                                </TextBlock>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!--  运行时间  -->
                <StackPanel
                    Grid.Column="5"
                    Margin="8,0"
                    Orientation="Horizontal">
                    <ui:SymbolIcon
                        Margin="0,0,4,0"
                        FontSize="14"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Symbol="Timer24" />
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                        <Run Text="Uptime: " />
                        <Run Text="{Binding SystemStatus.RunningTime, Mode=OneWay, StringFormat={}{0:hh\\:mm\\:ss}}" />
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>

        <!--  Growl消息容器  -->
        <StackPanel
            Name="GrowlPanel"
            Grid.Row="1"
            Margin="0,10,10,0"
            HorizontalAlignment="Right"
            VerticalAlignment="Top"
            Panel.ZIndex="1000"
            hc:Growl.GrowlParent="True" />
    </Grid>
</ui:FluentWindow>